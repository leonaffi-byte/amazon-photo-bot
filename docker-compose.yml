version: "3.9"

services:
  amazon-bot:
    image: amazon-photo-bot
    build: .
    container_name: amazon-photo-bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      # DB and logs live under /app/data so the volume mount persists them
      DATA_DIR: /app/data
    ports:
      # URL shortener — Nginx proxies amznl.cc → this port
      - "8080:8080"
    volumes:
      # Single directory mount — contains both bot_data.db and bot.log
      - ./data:/app/data
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  test-bot:
    image: amazon-photo-bot          # reuse same image (built above)
    container_name: amazon-test-bot
    restart: unless-stopped
    command: python testbot.py        # different entrypoint
    env_file:
      - .env
    environment:
      DATA_DIR: /app/data
    volumes:
      # Share the same data dir → same DB → same API keys
      - ./data:/app/data
    depends_on:
      - amazon-bot
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
